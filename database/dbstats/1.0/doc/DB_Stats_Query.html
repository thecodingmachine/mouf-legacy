<h1>DB_Stats_Query: performing a query on a stats table</h1>

<p>In order to perform a query on a stats table generated by <a href="index.html"><code>DB_Stats</code></a>, we can use the <code>DB_Stats_Query</code>.</p>

<h2>The theory behind queries on stats tables</h2>

<p>There are essentially 3 types of actions we can take on each column of a stats table:</p>
<ul>
	<li>Filter on that column (for instance, display only the year 2008)</li>
 	<li>Do not filter and display everything (display all the years)</li>
 	<li>Sum up the content of the column (let's display the sum for all the years).</li>
 </ul>
 
<p>Please note that it is the responsibility of the developer to query according to the dimensions.
For instance, if one dimension is "year->month->day", the developer CANNOT sum up years but filter on the month:
You must first apply filters, then sum the latest columns of the dimension if you want.</p>

<pre>
+--------------------------------------------------------+
| DB_StatsQuery                                          |
+--------------------------------------------------------+
| + setDbStats(DB_Stats dbStats)                         |
| + addFilter(DB_StatFilter filter)                      |
| + query()                                              |
+--------------------------------------------------------+
</pre>

<p>In order to perform a query, we must first create an instance of the DB_StatsQuery object. This object must be connected directly to the
DB_Stats object we will perform requests on. Once this is done, we just need to add filters. There are
3 classes implementing the DB_StatFilter interface:</p>
<ul>
	<li><b>DB_ValueFilter:</b> Filter on a column</li>
	<li><b>DB_SumFilter:</b> Sum up the content of the column</li>
	<li><b>DB_AllValuesFilter:</b> Do not filter and display everything</li>
</ul>

<h3>Filter on a column</h3>

<p>We can filter on a column, for a specific value:</p>

<pre>
+--------------------------------------------------------+
| DB_ValueFilter                                         |
+--------------------------------------------------------+
| + setColumnName(string name)                           |
| + setValue(string value)                               |
+--------------------------------------------------------+
</pre>

<p>For instance, if we want to get results only for the year 2009, we will use:</p>

<pre>
$query = new DB_Stats_Query();
$query->setDbStats($dbStats);

$yearFilter = new DB_ValueFilter();
$yearFilter->setColumnName("year");
$yearFilter->setValue("2009");

$query->addFilter($yearFilter);
</pre>

<h3>Displays all the values of a column</h3>

<p>In order to get all the possible values (and subtotals) for a column, we use the <code>DB_AllValuesFilter</code></p>

<pre>
+--------------------------------------------------------+
| DB_AllValuesFilter                                     |
+--------------------------------------------------------+
| + setColumnName(string name)                           |
+--------------------------------------------------------+
</pre>

<p>For instance:</p>

<pre>
$monthFilter = new DB_AllValuesFilter();
$monthFilter->setColumnName("month");

$query->addFilter($monthFilter);
</pre>

<h3>Default filter</h3>
<p>A third type of Filter allow to sum up the values of a column and return the total : the <code>DB_SumFilter</code>.</p>
<pre>
+--------------------------------------------------------+
| DB_SumFilter                                           |
+--------------------------------------------------------+
| + setColumnName(string name)                           |
+--------------------------------------------------------+
</pre>
<p>Please note that creating DB_SumFilter is <em>optional</em>. Indeed, if a column is not stated in any filter, by default, a DB_SumFilter will be applied on that column.</p>


<h2>Running the query</h2>

<p>Running a query is straightforward once everything is configured. You just need to run the <code>query</code> method.</p>

<pre>
$results = $query->query();
</pre>

<p>Results are returned as an array of rows. Each row is an associative array containing the name of the column as a key, and its value as the value.</p>

<p>For instance, with the previoussly defined year and month filter, the result will be aggregated values for each different month of the year 2009: </p>
<p>The following code : </p>
<pre>
 foreach ($results as $row) {
	$i++;
	echo $i.' - '.'For patients created on Month : '.$row["month"].', aggredated wieght is: '.$row["sumweight"]
		.', aggredated size is : '.$row["sumsize"].', while average age is : '.$row["sumage"]/$row["cnt"];
	echo "&lt;br/&gt;";
 }
</pre>
<p>Will display :</p>
<p>
1 - For patients created on Month : 6, aggredated wieght is: 50, aggredated size : 170, while average age is : 25<br/>
2 - For patients created on Month : 7, aggredated wieght is: 145, aggredated size : 355, while average age is : 29.25<br/>
3 - For patients created on Month : 8, aggredated wieght is: 120, aggredated size : 360, while average age is : 47,5
</p>